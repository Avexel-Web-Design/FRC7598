import{b as it,c as lt,r as p,j as e,f}from"./main-mLY0D8cE.js";import{g as A}from"./color-DkCkRny3.js";import{N as ne}from"./NebulaLoader-D1au-Ulo.js";import{f as Ge,a as Fe,b as Oe,c as Ve,N as He,I as Ue,C as Be,T as qe,R as re,S as We,d as ot}from"./index-CjjgASe8.js";import{f as Qe,a as Ye,F as Y,b as ct}from"./index-BKDONh5e.js";const ht=()=>{var Le;const{user:n}=it(),{unreadCounts:ie,markChannelAsRead:Ke,refreshNotifications:Je,setActiveChannel:R}=lt(),[le,G]=p.useState([]),[l,E]=p.useState(null),[j,C]=p.useState([]),[T,oe]=p.useState(""),[ce,de]=p.useState(!0),[Xe,ue]=p.useState(!1),[pe,me]=p.useState(!1),[xe,_]=p.useState(null),he=p.useRef(null),K=p.useRef(null),[w,F]=p.useState(null),[v,J]=p.useState(null),[ge,O]=p.useState(null),[z,V]=p.useState(null),[fe,X]=p.useState(null),H=p.useRef(null),U=p.useRef(null),[Ze,S]=p.useState(!1),[M,be]=p.useState("create"),[Z,ye]=p.useState(null),[je,ee]=p.useState(""),[B,q]=p.useState([]),[we,te]=p.useState([]),[ve,Ne]=p.useState(!1),[Ce,k]=p.useState(""),ke=p.useMemo(()=>[{key:"heart",icon:Ge,title:"Heart"},{key:"thumbs_up",icon:Fe,title:"Like"},{key:"thumbs_down",icon:Oe,title:"Dislike"},{key:"laugh",icon:Ve,title:"Laugh"},{key:"exclamation",icon:Qe,title:"Exclamation"},{key:"question",icon:Ye,title:"Question"}],[]),et=p.useMemo(()=>({heart:Ge,thumbs_up:Fe,thumbs_down:Oe,laugh:Ve,exclamation:Qe,question:Ye}),[]),$=(t,s)=>{const[a,r]=[t,s].sort((i,d)=>i-d);return`dm_${a}_${r}`},_e=t=>[...t].sort((s,a)=>new Date(s.timestamp)-new Date(a.timestamp)),Se=t=>{const s=new Date(t),a=new Date;return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()?s.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0}):s.toLocaleDateString(void 0,{month:"numeric",day:"numeric"})},se=async(t=!1)=>{if(n)try{t||de(!0),_(null);let s=[];const a=await f.get(`/chat/users/recent?user_id=${n.id}`);if(a.ok)s=await a.json();else{const c=await f.get("/chat/users");c.ok&&(s=(await c.json()).filter(u=>u.id!==n.id))}let r=[];const i=await f.get(`/chat/groups?user_id=${n.id}`);i.ok&&(r=await i.json());const d=[...r.map(c=>({...c,type:"group"})),...s.map(c=>({...c,type:"dm"}))];d.sort((c,u)=>{const x=c.type==="group"?c.last_activity||c.created_at||"":c.last_message_time||"",b=u.type==="group"?u.last_activity||u.created_at||"":u.last_message_time||"";if(x&&b)return b.localeCompare(x);if(x)return-1;if(b)return 1;const D=c.type==="group"?c.name:c.username,m=u.type==="group"?u.name:u.username;return D.localeCompare(m,void 0,{sensitivity:"base"})}),G(d)}catch{_("Error loading chats")}finally{t||de(!1)}};p.useEffect(()=>{n&&se()},[n]),p.useEffect(()=>{(async()=>{if(!(!l||!n)){ue(!0),_(null);try{let s="";l.type==="dm"?s=`/chat/messages/dm/${$(n.id,l.id)}?user_id=${n.id}`:s=`/chat/messages/${l.id}?user_id=${n.id}`;const a=await f.get(s);a.ok?C(_e(await a.json())):C([])}catch{C([])}finally{ue(!1)}}})()},[l,n]),p.useEffect(()=>{var t;(t=he.current)==null||t.scrollIntoView({behavior:"smooth"})},[j]),p.useEffect(()=>()=>R(null),[R]),p.useEffect(()=>{if(l&&n){const t=l.type==="dm"?$(n.id,l.id):l.id.toString();R(t)}},[l,n,R]),p.useEffect(()=>{const t=s=>{const a=s.target,r=H.current&&a?H.current.contains(a):!1,i=U.current&&a?U.current.contains(a):!1;r||F(null),i||J(null)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[w,v]);const Me=async()=>{try{const t=await f.get("/chat/users");t.ok?te(await t.json()):te([])}catch{te([])}},$e=async()=>{be("create"),ye(null),ee(""),q([]),k(""),await Me(),S(!0)},De=async t=>{be("edit"),ye(t.id),ee(t.name||""),q([]),k(""),await Me();try{const s=await f.get(`/chat/channels/${t.id}/members`);if(s.ok){const r=(await s.json()||[]).map(i=>i.user_id).filter(i=>i!==(n==null?void 0:n.id));q(r)}}catch{}S(!0)},tt=t=>{q(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},st=async()=>{if(!n)return;k("");const t=je.trim();if(!t){k("Group name is required");return}if(B.length===0&&M==="create"){k("Select at least one member");return}Ne(!0);try{if(M==="create"){const s=await f.post("/chat/groups",{name:t,created_by:n.id,members:B});if(s.ok){const a=await s.json();S(!1),await se(!0);const r={type:"group",id:a.id,name:a.name};E(r)}else{const a=await s.text();k(a||"Failed to create group")}}else{const s=Array.from(new Set([...B||[],n.id])),a=await f.put(`/chat/groups/${Z}`,{name:t,members:s});if(a.ok)S(!1),await se(!0),G(r=>r.map(i=>i.type==="group"&&i.id===Z?{...i,name:t}:i)),E(r=>r&&r.type==="group"&&r.id===Z?{...r,name:t}:r);else{const r=await a.text();k(r||"Failed to update group")}}}catch{k(M==="create"?"Error creating group":"Error updating group")}finally{Ne(!1)}},Ie=async t=>{if(!(!n||t.type!=="group")&&window.confirm(`Delete group "${t.name}"? All messages will be permanently deleted.`))try{(await f.delete(`/chat/groups/${t.id}`)).ok&&(G(a=>a.filter(r=>!(r.type==="group"&&r.id===t.id))),l&&l.type==="group"&&l.id===t.id&&E(null))}catch{}},Re=t=>{if(E(t),!n)return;const s=t.type==="dm"?$(n.id,t.id):t.id.toString();R(s),Ke(s)},L=t=>{const s=t.match(/^::reply\[(\d+)\]::([\s\S]*)$/);return s?{replyId:parseInt(s[1],10),text:s[2]}:{replyId:null,text:t}},at=async t=>{if(t.preventDefault(),!(!T.trim()||!l||!n))try{const s=z?`::reply[${z.id}]::${T.trim()}`:T.trim();let a="";if(l.type==="dm"?a=`/chat/messages/dm/${$(n.id,l.id)}?user_id=${n.id}`:a=`/chat/messages/${l.id}?user_id=${n.id}`,(await f.post(a,{content:s,sender_id:n.id})).ok){const i=await f.get(a);i.ok&&C(_e(await i.json())),oe(""),V(null),Je(),G(d=>{const c=d.findIndex(u=>u.type===l.type&&u.id===l.id);if(c>=0){const u=[...d],[x]=u.splice(c,1),b=new Date().toISOString();return x.type==="dm"?x.last_message_time=b:x.last_activity=b,u.unshift(x),u}return d})}}catch{_("Error sending message")}},Ee=async(t,s)=>{if(n&&!(!(s!=null&&s.shiftKey)&&!window.confirm("Delete this message?"))){me(!0);try{(await f.request("DELETE",`/chat/messages/${t}`,{user_id:n.id})).ok&&C(r=>r.filter(i=>i.id!==t))}catch{}finally{me(!1)}}},Te=async t=>{try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(t),!0}catch{}try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.focus(),s.select();const a=document.execCommand("copy");return document.body.removeChild(s),a}catch{return!1}},ae=async(t,s)=>{if(!(!s||!n)){C(a=>a.map(r=>{if(r.id!==t)return r;const i={...r.reaction_counts||{}},d=new Set(r.my_reactions||[]);if(d.has(s)){const u=(i[s]||0)-1;u<=0?delete i[s]:i[s]=u,d.delete(s)}else i[s]=(i[s]||0)+1,d.add(s);return{...r,reaction_counts:i,my_reactions:Array.from(d)}})),F(null);try{(await f.post(`/chat/messages/${t}/reactions/${s}/toggle?user_id=${n.id}`)).ok||(C(r=>r.map(i=>{if(i.id!==t)return i;const d={...i.reaction_counts||{}},c=new Set(i.my_reactions||[]);if(c.has(s)){const x=(d[s]||0)-1;x<=0?delete d[s]:d[s]=x,c.delete(s)}else d[s]=(d[s]||0)+1,c.add(s);return{...i,reaction_counts:d,my_reactions:Array.from(c)}})),_("Failed to toggle reaction"))}catch{C(a=>a.map(r=>{if(r.id!==t)return r;const i={...r.reaction_counts||{}},d=new Set(r.my_reactions||[]);if(d.has(s)){const u=(i[s]||0)-1;u<=0?delete i[s]:i[s]=u,d.delete(s)}else i[s]=(i[s]||0)+1,d.add(s);return{...r,reaction_counts:i,my_reactions:Array.from(d)}})),_("Failed to toggle reaction")}}},nt=t=>{const s=new Map(j.map(m=>[m.id,m])),a=new Map,r=new Map;for(const m of j){const{replyId:g}=L(m.content);if(g){a.set(m.id,g);const y=r.get(g)||[];y.push(m.id),r.set(g,y)}}const i=[],d=new Set;let c=t;for(;c!==void 0&&!d.has(c);){d.add(c);const m=a.get(c);if(m!=null){const g=s.get(m);g&&i.unshift(g),c=m}else break}const u=[],x=[t],b=new Set([t]);for(;x.length;){const m=x.shift(),g=r.get(m)||[];for(const y of g){if(b.has(y))continue;b.add(y);const W=s.get(y);W&&u.push(W),x.push(y)}}u.sort((m,g)=>new Date(m.timestamp)-new Date(g.timestamp));const D=s.get(t);return{items:[...i,...D?[D]:[],...u]}},ze=t=>!!n&&(n.isAdmin||t.sender_id===n.id);return e.jsxs("div",{className:"flex h-full w-full bg-black text-gray-100 overflow-hidden",children:[e.jsxs("div",{className:"hidden md:flex w-64 bg-black flex-col",children:[e.jsx("div",{className:"px-2",children:e.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Messages"}),e.jsx("button",{onClick:$e,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-1",title:"Create group chat",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})}),ce?e.jsx("div",{className:"flex items-center justify-center p-4",children:e.jsx(ne,{size:48})}):e.jsx("nav",{className:"flex-1 p-2 space-y-2 overflow-y-auto",children:le.map(t=>{const s=`${t.type}-${t.id}`,a=t.type==="group"?t.name:t.username,r=t.type==="group"?"#4b5563":t.avatar_color||A(a,null),i=t.type==="dm"&&n?$(n.id,t.id):t.id.toString(),d=ie[i]||0,c=(l==null?void 0:l.type)===t.type&&(l==null?void 0:l.id)===t.id;return e.jsxs("div",{className:`flex items-center justify-between w-full py-2 px-3 rounded-md ${c?"bg-sca-purple text-white":"hover:text-sca-purple"}`,children:[e.jsxs("button",{onClick:()=>Re(t),className:"flex items-center gap-3 flex-1 text-left",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm",style:{backgroundColor:r},children:a==null?void 0:a.split(" ").map(u=>u[0]).join("").toUpperCase().substring(0,2)}),d>0&&e.jsx(He,{count:d,position:"top-right",size:"medium"})]}),e.jsx("span",{className:"truncate",children:a})]}),(n==null?void 0:n.isAdmin)&&t.type==="group"&&e.jsxs("div",{className:"flex gap-2 pl-2",children:[e.jsx("button",{onClick:u=>{u.stopPropagation(),De(t)},className:"text-gray-400 hover:text-white",title:"Edit group",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})})}),e.jsx("button",{onClick:u=>{u.stopPropagation(),Ie(t)},className:"text-gray-400 hover:text-red-400",title:"Delete group",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]},s)})})]}),e.jsx("div",{className:"md:hidden",children:l?null:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Messages"}),e.jsx("button",{onClick:$e,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-2",title:"Create group chat",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),ce?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(ne,{size:48})}):e.jsx("div",{className:"space-y-3",children:le.map(t=>{const s=`${t.type}-${t.id}`,a=t.type==="group"?t.name:t.username,r=t.type==="group"?"#4b5563":t.avatar_color||A(a,null),i=t.type==="dm"&&n?$(n.id,t.id):t.id.toString(),d=ie[i]||0;return e.jsxs("div",{className:"w-full py-4 px-4 rounded-xl border border-gray-700 hover:border-sca-purple hover:bg-gray-800 active:bg-gray-700 transition-all duration-200 flex items-center justify-between mobile-touch-target",children:[e.jsxs("button",{onClick:()=>Re(t),className:"flex items-center gap-3 flex-1 text-left",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-base",style:{backgroundColor:r},children:a==null?void 0:a.split(" ").map(c=>c[0]).join("").toUpperCase().substring(0,2)}),d>0&&e.jsx(He,{count:d,position:"top-right",size:"medium"})]}),e.jsx("span",{className:"font-medium text-base",children:a})]}),(n==null?void 0:n.isAdmin)&&t.type==="group"&&e.jsxs("div",{className:"flex gap-3 pl-2",children:[e.jsx("button",{onClick:c=>{c.stopPropagation(),De(t)},className:"text-gray-400 hover:text-white",title:"Edit group",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),Ie(t)},className:"text-gray-400 hover:text-red-400",title:"Delete group",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]},s)})})]})}),e.jsxs("div",{className:`flex-1 flex flex-col min-h-0 ${l?"":"hidden md:flex"}`,children:[e.jsx("div",{className:"bg-black px-2",children:e.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>E(null),className:"md:hidden mr-3 p-2 hover:text-sca-purple hover:bg-gray-800 rounded-lg transition-colors mobile-touch-target",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("h2",{className:"text-lg md:text-xl font-bold truncate",children:l?l.type==="group"?l.name:l.username:"Select a chat"})]}),e.jsxs("div",{className:"hidden md:flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg",style:{backgroundColor:n!=null&&n.name?A(n.name,(n==null?void 0:n.avatarColor)||null):"#471a67"},children:(Le=n==null?void 0:n.name)==null?void 0:Le.split(" ").map(t=>t[0]).join("").toUpperCase().substring(0,2)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:n==null?void 0:n.name}),e.jsx("p",{className:"text-sm text-gray-400",children:"Online"})]})]})]})}),xe&&e.jsxs("div",{className:"bg-red-500 text-white p-2 text-sm text-center",children:[xe,e.jsx("button",{onClick:()=>_(null),className:"ml-2 font-bold",children:"×"})]}),e.jsxs("div",{className:"flex-1 p-4 overflow-y-auto pb-20 md:pb-4",children:[Xe?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(ne,{size:64})}):l?j.length>0?e.jsx("div",{className:"flex flex-col justify-end min-h-full",children:j.map((t,s)=>{var Ae;const a=!!n&&t.sender_id===n.id,r=s>0?j[s-1]:null,i=s<j.length-1?j[s+1]:null,d=(l==null?void 0:l.type)==="group",c=12e4,u=new Date(t.timestamp).getTime(),x=r?new Date(r.timestamp).getTime():0,b=i?new Date(i.timestamp).getTime():0,D=!!r&&r.sender_id===t.sender_id,m=!!i&&i.sender_id===t.sender_id,g=!(D&&u-x<=c),y=!(m&&b-u<=c),W=e.jsx("div",{className:"w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white font-bold text-sm md:text-lg",style:{backgroundColor:t.sender_avatar_color||A(t.sender_username,null)},children:(Ae=t.sender_username)==null?void 0:Ae.split(" ").map(o=>o[0]).join("").toUpperCase().substring(0,2)}),rt=(()=>{const o=!a&&g&&d?"rounded-2xl":"rounded-3xl",h=[];return g||h.push(a?"rounded-tr-md":"rounded-tl-md"),y||h.push(a?"rounded-br-md":"rounded-bl-md"),[o,...h].join(" ")})(),I=L(t.content),Q=I.replyId?j.find(o=>o.id===I.replyId):null,Pe=Q?L(Q.content):null,P=Pe?Pe.text:"";return e.jsxs("div",{id:`msg-${t.id}`,className:`relative flex items-end gap-2 mb-1 ${g?"mt-3":"mt-0"} group ${a?"justify-end":"justify-start"}`,children:[!a&&d&&(y?e.jsx("div",{className:"self-end",children:W}):e.jsx("div",{className:"w-8 md:w-10"})),a&&e.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${w===t.id||v===t.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:o=>{w===t.id&&(H.current=o),v===t.id&&(U.current=o)},children:[e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),J(v===t.id?null:t.id)},title:"Message info",children:e.jsx(Ue,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async o=>{o.stopPropagation(),await Te(I.text)&&(O(t.id),setTimeout(()=>O(N=>N===t.id?null:N),1200))},title:ge===t.id?"Copied!":"Copy message",children:e.jsx(Be,{className:"w-4 h-4"})}),ze(t)&&e.jsx("button",{onClick:o=>Ee(t.id,o),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:pe,children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),V(t),setTimeout(()=>{var h;return(h=K.current)==null?void 0:h.focus()},0)},title:"Reply",children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),F(w===t.id?null:t.id)},title:"Add reaction",children:e.jsx(We,{className:"w-4 h-4"})}),w===t.id&&e.jsx("div",{className:"absolute bottom-full right-0 mb-2 z-20",children:e.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:e.jsx("div",{className:"flex items-center gap-1",children:ke.map(({key:o,icon:h,title:N})=>e.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:N,onClick:()=>ae(t.id,o),children:e.jsx(Y,{icon:h,className:"w-4 h-4"})},o))})})}),v===t.id&&e.jsx("div",{className:"absolute bottom-full right-full mr-2 mb-2 z-20",children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[e.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),e.jsxs("div",{className:"text-gray-400",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"From:"})," ",t.sender_username]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"ID:"})," ",t.id]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(t.timestamp).toLocaleString()]}),l&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Chat:"})," ",l.type==="group"?l.name:l.username]})]})]})})]}),e.jsxs("div",{className:`max-w-[85%] px-3 py-2 ${rt} shadow-sm ${a?"bg-sca-purple text-white":"bg-gray-800 text-gray-100"}`,children:[I.replyId&&e.jsx("button",{type:"button",onClick:()=>X(t.id),className:`mb-1 text-xs rounded-md px-2 py-1 border ${a?"bg-white/10 border-white/30 text-white/90":"bg-black/20 border-white/10 text-gray-300"}`,title:"View replied message",children:e.jsxs("span",{className:"opacity-80",children:["Replying to ",Q?Q.sender_username:"message",": ",P==null?void 0:P.slice(0,80),P&&P.length>80?"…":""]})}),!a&&g&&d&&e.jsx("div",{className:"text-xs font-semibold mb-1 opacity-90",children:t.sender_username}),e.jsxs("div",{className:`whitespace-pre-wrap break-words ${a?"text-right":""}`,children:[e.jsx("span",{children:I.text}),y&&e.jsxs("span",{className:`ml-2 text-[10px] ${a?"text-white/80":"text-gray-400"} whitespace-nowrap align-baseline`,children:[Se(t.timestamp),a&&e.jsx("span",{className:"ml-1 inline-flex items-center align-baseline",children:e.jsx(Y,{icon:t.read_by_any?ct:ot,className:"w-3.5 h-3.5 opacity-90",title:t.read_by_any?"Read":"Sent"})})]}),Object.keys(t.reaction_counts||{}).length>0&&e.jsx("div",{className:`mt-1 flex flex-wrap gap-1 ${a?"justify-end":"justify-start"}`,children:Object.entries(t.reaction_counts||{}).map(([o,h])=>e.jsxs("button",{type:"button",onClick:()=>ae(t.id,o),className:`px-1.5 py-0.5 rounded-full text-xs border transition-colors ${(t.my_reactions||[]).includes(o)?a?"bg-white/20 border-white/40":"bg-white/10 border-white/20":a?"bg-black/10 border-white/20":"bg-black/20 border-white/10"}`,title:"Toggle reaction",children:[e.jsx(Y,{icon:et[o],className:"w-3.5 h-3.5 mr-1 inline-block"}),e.jsx("span",{className:"tabular-nums",children:h})]},o))})]})]}),!a&&e.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${w===t.id||v===t.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:o=>{w===t.id&&(H.current=o),v===t.id&&(U.current=o)},children:[e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),F(w===t.id?null:t.id)},title:"Add reaction",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),V(t),setTimeout(()=>{var h;return(h=K.current)==null?void 0:h.focus()},0)},title:"Reply",children:e.jsx(re,{className:"w-4 h-4"})}),ze(t)&&e.jsx("button",{onClick:o=>Ee(t.id,o),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:pe,children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async o=>{o.stopPropagation(),await Te(I.text)&&(O(t.id),setTimeout(()=>O(N=>N===t.id?null:N),1200))},title:ge===t.id?"Copied!":"Copy message",children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:o=>{o.stopPropagation(),J(v===t.id?null:t.id)},title:"Message info",children:e.jsx(Ue,{className:"w-4 h-4"})}),w===t.id&&e.jsx("div",{className:"absolute bottom-full left-0 mb-2 z-20",children:e.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:e.jsx("div",{className:"flex items-center gap-1",children:ke.map(({key:o,icon:h,title:N})=>e.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:N,onClick:()=>ae(t.id,o),children:e.jsx(Y,{icon:h,className:"w-4 h-4"})},o))})})}),v===t.id&&e.jsx("div",{className:"absolute bottom-full left-full ml-2 mb-2 z-20",children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[e.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),e.jsxs("div",{className:"text-gray-400",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"From:"})," ",t.sender_username]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"ID:"})," ",t.id]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(t.timestamp).toLocaleString()]}),l&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Chat:"})," ",l.type==="group"?l.name:l.username]})]})]})})]})]},t.id)})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-400",children:"No messages yet. Say hi!"})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-400",children:"Select a chat to start messaging."})}),e.jsx("div",{ref:he})]}),e.jsx("div",{className:"bg-black px-2 pb-safe sticky bottom-0 md:relative md:bottom-auto",children:e.jsxs("div",{className:"p-4 border-t border-gray-700",children:[z&&e.jsxs("div",{className:"mb-2 flex items-center gap-2 rounded-md border border-gray-700 bg-gray-900 p-2",children:[e.jsx(re,{className:"w-4 h-4 text-sca-purple"}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"text-xs text-gray-400",children:["Replying to ",z.sender_username]}),e.jsx("div",{className:"text-sm truncate",children:L(z.content).text})]}),e.jsx("button",{type:"button",className:"text-gray-400 hover:text-red-400 px-2",title:"Cancel reply",onClick:()=>V(null),children:"×"})]}),e.jsxs("form",{onSubmit:at,className:"flex space-x-2",children:[e.jsx("input",{type:"text",ref:K,value:T,onChange:t=>oe(t.target.value),placeholder:l?`Message ${l.type==="group"?l.name:l.username}`:"Select a chat...",className:"flex-1 bg-gray-800 text-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sca-purple border border-gray-600",disabled:!l}),e.jsxs("button",{type:"submit",className:"bg-sca-purple hover:bg-sca-purple/80 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!l||!T.trim(),children:[e.jsx("span",{className:"hidden sm:inline",children:"Send"}),e.jsx("svg",{className:"w-5 h-5 sm:hidden",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})]})]})]})})]}),fe!=null&&(()=>{const{items:t}=nt(fe);return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:()=>X(null),children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-4",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Thread"}),e.jsx("button",{className:"text-gray-400 hover:text-white",onClick:()=>X(null),title:"Close",children:"×"})]}),e.jsx("div",{className:"space-y-3",children:t.map(s=>{const a=!!n&&s.sender_id===n.id,r=L(s.content);return e.jsxs("div",{className:`p-3 rounded-xl border ${a?"bg-sca-purple/10 border-sca-purple/40":"bg-black/30 border-white/10"}`,children:[e.jsxs("div",{className:"text-xs text-gray-400 mb-1 flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-300",children:s.sender_username}),e.jsx("span",{children:Se(s.timestamp)})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words",children:r.text})]},`thread-${s.id}`)})})]})})})(),Ze&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:()=>S(!1),children:e.jsxs("div",{className:"bg-gray-900 border border-white/10 rounded-lg p-5 w-full max-w-md",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:M==="create"?"New Group Chat":"Edit Group Chat"}),Ce&&e.jsx("div",{className:"mb-2 bg-red-500/20 text-red-200 border border-red-500/40 rounded p-2",children:Ce}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400",children:"Group name"}),e.jsx("input",{value:je,onChange:t=>ee(t.target.value),placeholder:"Project Tigers",className:"w-full px-3 py-2 rounded bg-gray-800 border border-white/10"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Select members"}),e.jsxs("div",{className:"max-h-48 overflow-y-auto bg-gray-800 border border-white/10 rounded p-2",children:[we.length===0&&e.jsx("p",{className:"text-gray-400 text-sm",children:"No users found."}),we.map(t=>{var s;return e.jsxs("label",{className:"flex items-center gap-2 py-1 text-sm",children:[e.jsx("input",{type:"checkbox",disabled:t.id===(n==null?void 0:n.id),checked:t.id===(n==null?void 0:n.id)?!0:B.includes(t.id),onChange:()=>tt(t.id)}),e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:t.avatar_color||A(t.username,null)},children:(s=t.username)==null?void 0:s.split(" ").map(a=>a[0]).join("").toUpperCase().substring(0,2)}),t.username,t.id===(n==null?void 0:n.id)&&e.jsx("span",{className:"text-xs text-gray-400",children:"(you)"})]})]},t.id)})]})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>S(!1),className:"px-4 py-2 rounded bg-white/10",children:"Cancel"}),e.jsx("button",{onClick:st,disabled:ve,className:"px-4 py-2 rounded bg-sca-purple disabled:opacity-50",children:ve?M==="create"?"Creating…":"Saving…":M==="create"?"Create Group":"Save Changes"})]})]})})]})};export{ht as default};
