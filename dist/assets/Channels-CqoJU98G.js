import{b as gt,c as jt,r as o,j as e,f as p}from"./main-Da7mm-km.js";import{g as Pe}from"./color-DkCkRny3.js";import{N as de}from"./NebulaLoader-YoIkvoO_.js";import{f as ze,a as Oe,b as Be,c as He,N as Ue,I as Ve,C as qe,T as We,R as ue,S as Qe,d as yt,P as wt}from"./index-By6kbUnf.js";import{f as Ye,a as Ke,F as se,b as vt}from"./index-DXFDpy_a.js";const $t=()=>{var Ae;const{user:n}=gt(),{unreadCounts:O,markChannelAsRead:Ge,refreshNotifications:Je,setActiveChannel:$}=jt(),[c,B]=o.useState({id:"general",name:"# general"}),[R,me]=o.useState(""),[H,k]=o.useState([]),[y,w]=o.useState([]),[U,m]=o.useState(null),[he,xe]=o.useState(!0),[Xe,pe]=o.useState(!1),[fe,be]=o.useState(!1),ge=o.useRef(null),ae=o.useRef(null),je=o.useRef(null),ye=o.useRef(null),[v,V]=o.useState(null),[N,ne]=o.useState(null),[ie,q]=o.useState(null),[T,W]=o.useState(null),[we,re]=o.useState(null),Q=o.useRef(null),Y=o.useRef(null),[S,K]=o.useState(null),[Ze,le]=o.useState(null),[et,L]=o.useState(!1),[G,ve]=o.useState("create"),[D,A]=o.useState(""),[tt,J]=o.useState(""),[Ne,Ce]=o.useState(!1),[M,F]=o.useState(!1),[ke,st]=o.useState([]),[E,I]=o.useState([]),Se=o.useMemo(()=>[{key:"heart",icon:ze,title:"Heart"},{key:"thumbs_up",icon:Oe,title:"Like"},{key:"thumbs_down",icon:Be,title:"Dislike"},{key:"laugh",icon:He,title:"Laugh"},{key:"exclamation",icon:Ye,title:"Exclamation"},{key:"question",icon:Ke,title:"Question"}],[]),at=o.useMemo(()=>({heart:ze,thumbs_up:Oe,thumbs_down:Be,laugh:He,exclamation:Ye,question:Ke}),[]),oe=t=>[...t].sort((s,a)=>new Date(s.timestamp)-new Date(a.timestamp)),_e=t=>{const s=new Date(t),a=new Date;return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()?s.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0}):s.toLocaleDateString(void 0,{month:"numeric",day:"numeric"})};o.useEffect(()=>{(async()=>{xe(!0),m(null);try{const s=await p.get(`/chat/channels?user_id=${(n==null?void 0:n.id)??""}`);if(s.ok){const a=await s.json();k(a)}else k([{id:"general",name:"# general"},{id:"random",name:"# random"}])}catch{k([{id:"general",name:"# general"}])}finally{xe(!1)}})()},[n]),o.useEffect(()=>{(async()=>{if(c){pe(!0),m(null);try{const s=await p.get(`/chat/messages/${c.id}?user_id=${(n==null?void 0:n.id)??""}`);if(s.ok){const a=await s.json();w(oe(a))}else w([])}catch{w([])}finally{pe(!1)}}})()},[c,n]),o.useEffect(()=>{var t;(t=ge.current)==null||t.scrollIntoView({behavior:"smooth"})},[y]),o.useEffect(()=>()=>$(null),[$]),o.useEffect(()=>{n&&$("general")},[n,$]),o.useEffect(()=>{c&&$(c.id)},[c,$]),o.useEffect(()=>{const t=s=>{const a=s.target,i=Q.current&&a?Q.current.contains(a):!1,r=Y.current&&a?Y.current.contains(a):!1;i||V(null),r||ne(null)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[v,N]);const nt=async t=>{if(t.preventDefault(),m(null),!(!R.trim()||!c||!n))try{const s=T?`::reply[${T.id}]::${R.trim()}`:R.trim(),a=await p.post(`/chat/messages/${c.id}?user_id=${n.id}`,{content:s,sender_id:n.id});if(a.ok){const i=await p.get(`/chat/messages/${c.id}?user_id=${n.id}`);i.ok&&w(oe(await i.json())),me(""),W(null),Je()}else m(`Failed to send message (${a.status})`)}catch{m("Error sending message")}},P=t=>{const s=t.match(/^::reply\[(\d+)\]::([\s\S]*)$/);return s?{replyId:parseInt(s[1],10),text:s[2]}:{replyId:null,text:t}},it=t=>{const s=new Map(y.map(b=>[b.id,b])),a=new Map,i=new Map;for(const b of y){const{replyId:g}=P(b.content);if(g){a.set(b.id,g);const j=i.get(g)||[];j.push(b.id),i.set(g,j)}}const r=[],d=new Set;let h=t;for(;h!==void 0&&!d.has(h);){d.add(h);const b=a.get(h);if(b!=null){const g=s.get(b);g&&r.unshift(g),h=b}else break}const u=[],x=[t],X=new Set([t]);for(;x.length;){const b=x.shift(),g=i.get(b)||[];for(const j of g){if(X.has(j))continue;X.add(j);const ee=s.get(j);ee&&u.push(ee),x.push(j)}}u.sort((b,g)=>new Date(b.timestamp)-new Date(g.timestamp));const Z=s.get(t);return{items:[...r,...Z?[Z]:[],...u],centerId:t}},$e=async(t,s)=>{if(!(!n||!(s!=null&&s.shiftKey)&&!window.confirm("Are you sure you want to delete this message?"))){m(null),be(!0);try{const i=await p.request("DELETE",`/chat/messages/${t}`,{user_id:n.id});if(i.ok)w(r=>r.filter(d=>d.id!==t));else{const r=await i.text();m(`Failed to delete message: ${r||i.status}`)}}catch{m("Error deleting message")}finally{be(!1)}}},De=async t=>{try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(t),!0}catch{}try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.focus(),s.select();const a=document.execCommand("copy");return document.body.removeChild(s),a}catch{return!1}},rt=t=>new Promise((s,a)=>{const i=new FileReader;i.onload=()=>{const r=i.result;if(typeof r=="string"){const d=r.indexOf(",");s({base64:r.substring(d+1),contentType:t.type||"application/octet-stream"})}else a(new Error("Unsupported result type"))},i.onerror=a,i.readAsDataURL(t)}),lt=()=>{var t;return(t=je.current)==null?void 0:t.click()},ot=async t=>{var a;const s=(a=t.target.files)==null?void 0:a[0];if(!(!s||!n||!c))try{const{base64:i,contentType:r}=await rt(s),d=await p.post("/uploads/image",{dataBase64:i,contentType:r,filename:s.name||"image"});if(d.ok){const{url:h}=await d.json(),u=`/chat/messages/${c.id}?user_id=${n.id}`;await p.post(u,{content:`::image::${h}`,sender_id:n.id});const x=await p.get(u);x.ok&&w(oe(await x.json()))}}catch{m("Failed to attach image")}finally{t.target.value=""}},ce=async(t,s)=>{if(!(!s||!n)){w(a=>a.map(i=>{if(i.id!==t)return i;const r={...i.reaction_counts||{}},d=new Set(i.my_reactions||[]);if(d.has(s)){const u=(r[s]||0)-1;u<=0?delete r[s]:r[s]=u,d.delete(s)}else r[s]=(r[s]||0)+1,d.add(s);return{...i,reaction_counts:r,my_reactions:Array.from(d)}})),V(null);try{(await p.post(`/chat/messages/${t}/reactions/${s}/toggle?user_id=${n.id}`)).ok||(w(i=>i.map(r=>{if(r.id!==t)return r;const d={...r.reaction_counts||{}},h=new Set(r.my_reactions||[]);if(h.has(s)){const x=(d[s]||0)-1;x<=0?delete d[s]:d[s]=x,h.delete(s)}else d[s]=(d[s]||0)+1,h.add(s);return{...r,reaction_counts:d,my_reactions:Array.from(h)}})),m("Failed to toggle reaction"))}catch{w(a=>a.map(i=>{if(i.id!==t)return i;const r={...i.reaction_counts||{}},d=new Set(i.my_reactions||[]);if(d.has(s)){const u=(r[s]||0)-1;u<=0?delete r[s]:r[s]=u,d.delete(s)}else r[s]=(r[s]||0)+1,d.add(s);return{...i,reaction_counts:r,my_reactions:Array.from(d)}})),m("Failed to toggle reaction")}}},Me=async()=>{try{const t=await p.get("/admin/users");t.ok&&st(await t.json())}catch{}},Re=()=>{ve("create"),A(""),J(""),F(!1),I(n?[n.id]:[]),L(!0),m(null),n!=null&&n.isAdmin&&Me()},ct=t=>{ve("edit"),A(t.name.replace("# ","")),J(t.id),F(t.is_private===1),I([]),L(!0),m(null),n!=null&&n.isAdmin&&Me()},dt=async()=>{if(!(!D.trim()||!n)){Ce(!0),m(null);try{const t=G==="create"?D.toLowerCase().replace(/\s+/g,"-"):tt;if(G==="create"){const s=await p.post("/chat/channels",{id:t,name:`# ${D.trim()}`,created_by:n.id,is_private:M,members:E});if(s.ok){const a=await p.get(`/chat/channels?user_id=${n.id}`);a.ok&&k(await a.json()),L(!1),A(""),J(""),F(!1),I([])}else{const a=await s.text();m(`Failed to create channel: ${a||s.status}`)}}else{const s=await p.put(`/chat/channels/${t}`,{name:`# ${D.trim()}`,is_private:M,members:E});if(s.ok){const a=await p.get(`/chat/channels?user_id=${n.id}`);a.ok&&k(await a.json()),L(!1),A(""),J(""),F(!1),I([])}else{const a=await s.text();m(`Failed to update channel: ${a||s.status}`)}}}catch{m("Error managing channel")}finally{Ce(!1)}}},ut=async t=>{if(t.id==="general"){alert("Cannot delete the general channel");return}if(window.confirm(`Are you sure you want to delete the channel "${t.name}"? All messages will be permanently deleted.`)){m(null);try{const s=await p.delete(`/chat/channels/${t.id}`);if(s.ok){if((c==null?void 0:c.id)===t.id){const i=H.find(r=>r.id==="general");i&&B(i)}const a=await p.get(`/chat/channels?user_id=${(n==null?void 0:n.id)??""}`);a.ok&&k(await a.json())}else{const a=await s.text();m(`Failed to delete channel: ${a||s.status}`)}}catch{m("Error deleting channel")}}},mt=(t,s)=>{if(!(n!=null&&n.isAdmin))return;K(s);const a=document.createElement("span");a.innerHTML=s.name,a.style.position="absolute",a.style.top="-9999px",document.body.appendChild(a),t.dataTransfer.setDragImage(a,0,0),t.dataTransfer.effectAllowed="move",setTimeout(()=>{document.body.removeChild(a)},0)},ht=(t,s)=>{t.preventDefault(),!(!(n!=null&&n.isAdmin)||!S||S.id===s)&&(t.dataTransfer.dropEffect="move",le(s))},xt=()=>le(null),pt=async(t,s)=>{if(t.preventDefault(),!(n!=null&&n.isAdmin)||!S||S.id===s.id){K(null),le(null);return}const a=[...H],i=a.findIndex(u=>u.id===S.id),r=a.findIndex(u=>u.id===s.id);if(i===-1||r===-1){K(null);return}const[d]=a.splice(i,1);a.splice(r,0,d);const h=a.map((u,x)=>({...u,position:x+1}));k(h),K(null);try{if(!(await p.post("/chat/channels/reorder",{channels:h.map(x=>({id:x.id,position:x.position}))})).ok){const x=await p.get(`/chat/channels?user_id=${(n==null?void 0:n.id)??""}`);x.ok&&k(await x.json())}}catch{}},Te=t=>{B(t),$(t.id),Ge(t.id)},Le=t=>!!n&&(n.isAdmin||t.sender_id===n.id);return e.jsxs("div",{className:"flex h-full w-full min-w-0 bg-black text-gray-100 overflow-hidden",children:[e.jsx("div",{className:"hidden md:flex w-64 bg-black flex-col",children:e.jsxs("div",{className:"pr-2",children:[e.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Channels"}),(n==null?void 0:n.isAdmin)&&e.jsx("button",{onClick:Re,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-1",title:"Create new channel",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),he?e.jsx("div",{className:"flex items-center justify-center p-4",children:e.jsx(de,{size:48})}):e.jsx("nav",{className:"flex-1 p-2 space-y-2 overflow-y-auto",children:H.map(t=>e.jsxs("div",{className:`flex items-center justify-between ${Ze===t.id?"border-2 border-sca-purple border-dashed bg-sca-purple/25":""} ${(S==null?void 0:S.id)===t.id?"opacity-50":""} rounded-md`,draggable:n==null?void 0:n.isAdmin,onDragStart:s=>mt(s,t),onDragOver:s=>ht(s,t.id),onDragLeave:xt,onDrop:s=>pt(s,t),children:[e.jsxs("button",{onClick:()=>Te(t),className:`flex-1 text-left py-2 px-3 rounded-md transition-colors duration-200 ${(c==null?void 0:c.id)===t.id?"bg-sca-purple text-white hover:text-white":"hover:text-sca-purple"} relative flex items-center justify-between`,children:[e.jsx("span",{children:t.name}),O[t.id]>0&&e.jsx(Ue,{count:O[t.id]})]}),(n==null?void 0:n.isAdmin)&&t.id!=="general"&&e.jsxs("div",{className:"flex space-x-1 pr-2",children:[e.jsx("button",{onClick:()=>ct(t),className:"text-gray-400 hover:text-sca-purple",title:"Edit channel",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})})}),e.jsx("button",{onClick:()=>ut(t),className:"text-gray-400 hover:text-red-500",title:"Delete channel",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]},t.id))})]})}),e.jsx("div",{className:`md:hidden ${c?"hidden":"flex-1 min-h-0"}`,onClick:t=>{if(c||t.target.closest('button, a, input, textarea, select, label, [role="button"]'))return;const s=ye.current;s&&B(s)},children:c?null:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Channels"}),(n==null?void 0:n.isAdmin)&&e.jsx("button",{onClick:Re,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-2",title:"Create new channel",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),he?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(de,{size:48})}):e.jsx("div",{className:"space-y-3",children:H.map(t=>e.jsxs("button",{onClick:()=>Te(t),className:"w-full text-left py-4 px-4 rounded-xl border border-gray-700 hover:border-sca-purple hover:bg-gray-800 active:bg-gray-700 transition-all duration-200 flex items-center justify-between mobile-touch-target",children:[e.jsx("span",{className:"font-medium text-base",children:t.name}),O[t.id]>0&&e.jsx(Ue,{count:O[t.id]})]},t.id))})]})}),e.jsxs("div",{className:`flex-1 flex flex-col min-h-0 min-w-0 ${c?"":"hidden md:flex"}`,children:[e.jsx("div",{className:"bg-black px-2 w-full",children:e.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>{ye.current=c,B(null)},className:"md:hidden mr-3 p-2 hover:text-sca-purple hover:bg-gray-800 rounded-lg transition-colors mobile-touch-target",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("h2",{className:"text-lg md:text-xl font-bold truncate",children:c?c.name:"Select a Channel"})]}),e.jsxs("div",{className:"hidden md:flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg",style:{backgroundColor:n!=null&&n.name?Pe(n.name,(n==null?void 0:n.avatarColor)||null):"#471a67"},children:(Ae=n==null?void 0:n.name)==null?void 0:Ae.split(" ").map(t=>t[0]).join("").toUpperCase().substring(0,2)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:n==null?void 0:n.name}),e.jsx("p",{className:"text-sm text-gray-400",children:"Online"})]})]})]})}),U&&e.jsxs("div",{className:"bg-red-500 text-white p-2 text-sm text-center",children:[U,e.jsx("button",{onClick:()=>m(null),className:"ml-2 font-bold",children:"×"})]}),e.jsxs("div",{className:"flex-1 min-w-0 p-4 overflow-y-auto overflow-x-hidden pb-20 md:pb-4",children:[Xe?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(de,{size:64})}):c?y.length>0?e.jsx("div",{className:"flex flex-col justify-end min-h-full",children:y.map((t,s)=>{var Ie;const a=!!n&&t.sender_id===n.id,i=s>0?y[s-1]:null,r=s<y.length-1?y[s+1]:null,d=12e4,h=new Date(t.timestamp).getTime(),u=i?new Date(i.timestamp).getTime():0,x=r?new Date(r.timestamp).getTime():0,X=!!i&&i.sender_id===t.sender_id,Z=!!r&&r.sender_id===t.sender_id,Fe=X&&h-u<=d,b=Z&&x-h<=d,g=!Fe,j=!b,ee=t.sender_avatar_color||Pe(t.sender_username,null),ft=e.jsx("div",{className:"w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white font-bold text-sm md:text-lg",style:{backgroundColor:ee},children:((Ie=t.sender_username)==null?void 0:Ie.split(" ").map(l=>l[0]).join("").toUpperCase().substring(0,2))||"??"}),bt=(()=>{const l=!a&&g?"rounded-2xl":"rounded-3xl",f=[];return g||f.push(a?"rounded-tr-md":"rounded-tl-md"),j||f.push(a?"rounded-br-md":"rounded-bl-md"),[l,...f].join(" ")})(),_=P(t.content),te=_.replyId?y.find(l=>l.id===_.replyId):null,Ee=te?P(te.content):null,z=Ee?Ee.text:"";return e.jsxs("div",{id:`msg-${t.id}`,className:`relative flex items-end gap-2 mb-1 ${g?"mt-3":"mt-0"} group ${a?"justify-end":"justify-start"}`,children:[!a&&(j?e.jsx("div",{className:"self-end",children:ft}):e.jsx("div",{className:"w-8 md:w-10"})),a&&e.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${v===t.id||N===t.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:l=>{v===t.id&&(Q.current=l),N===t.id&&(Y.current=l)},children:[e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),ne(N===t.id?null:t.id)},title:"Message info",children:e.jsx(Ve,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async l=>{l.stopPropagation(),await De(_.text)&&(q(t.id),setTimeout(()=>q(C=>C===t.id?null:C),1200))},title:ie===t.id?"Copied!":"Copy message",children:e.jsx(qe,{className:"w-4 h-4"})}),Le(t)&&e.jsx("button",{onClick:l=>$e(t.id,l),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:fe,children:e.jsx(We,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),W(t),setTimeout(()=>{var f;return(f=ae.current)==null?void 0:f.focus()},0)},title:"Reply",children:e.jsx(ue,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),V(v===t.id?null:t.id)},title:"Add reaction",children:e.jsx(Qe,{className:"w-4 h-4"})}),v===t.id&&e.jsx("div",{className:"absolute bottom-full right-0 mb-2 z-20",children:e.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:e.jsx("div",{className:"flex items-center gap-1",children:Se.map(({key:l,icon:f,title:C})=>e.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:C,onClick:()=>ce(t.id,l),children:e.jsx(se,{icon:f,className:"w-4 h-4"})},l))})})}),N===t.id&&e.jsx("div",{className:"absolute bottom-full right-full mr-2 mb-2 z-20",children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[e.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),e.jsxs("div",{className:"text-gray-400",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"From:"})," ",t.sender_username]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"ID:"})," ",t.id]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(t.timestamp).toLocaleString()]}),c&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Channel:"})," ",c.name]})]})]})})]}),e.jsxs("div",{className:`max-w-[85%] px-3 py-2 ${bt} shadow-sm ${a?"bg-sca-purple text-white":"bg-gray-800 text-gray-100"}`,children:[_.replyId&&e.jsx("button",{type:"button",onClick:()=>re(t.id),className:`mb-1 text-xs rounded-md px-2 py-1 border ${a?"bg-white/10 border-white/30 text-white/90":"bg-black/20 border-white/10 text-gray-300"}`,title:"View replied message",children:e.jsxs("span",{className:"opacity-80",children:["Replying to ",te?te.sender_username:"message",": ",z==null?void 0:z.slice(0,80),z&&z.length>80?"…":""]})}),!a&&g&&e.jsx("div",{className:"text-xs font-semibold mb-1 opacity-90",children:t.sender_username}),e.jsxs("div",{className:`whitespace-pre-wrap break-words ${a?"text-right":""}`,children:[_.text.startsWith("::image::")?e.jsx("img",{src:_.text.replace("::image::",""),alt:"attachment",className:"max-w-full rounded-lg border border-white/10"}):e.jsx("span",{children:_.text}),j&&e.jsxs("span",{className:`ml-2 text-[10px] ${a?"text-white/80":"text-gray-400"} whitespace-nowrap align-baseline`,children:[_e(t.timestamp),a&&e.jsx("span",{className:"ml-1 inline-flex items-center align-baseline",children:e.jsx(se,{icon:t.read_by_any||t.readers&&t.readers.length>0?vt:yt,className:"w-3.5 h-3.5 opacity-90",title:t.read_by_any||t.readers&&t.readers.length>0?"Read":"Sent"})})]}),Object.keys(t.reaction_counts||{}).length>0&&e.jsx("div",{className:`mt-1 flex flex-wrap gap-1 ${a?"justify-end":"justify-start"}`,children:Object.entries(t.reaction_counts||{}).map(([l,f])=>e.jsxs("button",{type:"button",onClick:()=>ce(t.id,l),className:`px-1.5 py-0.5 rounded-full text-xs border transition-colors ${(t.my_reactions||[]).includes(l)?a?"bg-white/20 border-white/40":"bg-white/10 border-white/20":a?"bg-black/10 border-white/20":"bg-black/20 border-white/10"}`,title:"Toggle reaction",children:[e.jsx(se,{icon:at[l],className:"w-3.5 h-3.5 mr-1 inline-block"}),e.jsx("span",{className:"tabular-nums",children:f})]},l))})]})]}),!a&&e.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${v===t.id||N===t.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:l=>{v===t.id&&(Q.current=l),N===t.id&&(Y.current=l)},children:[e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),V(v===t.id?null:t.id)},title:"Add reaction",children:e.jsx(Qe,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),W(t),setTimeout(()=>{var f;return(f=ae.current)==null?void 0:f.focus()},0)},title:"Reply",children:e.jsx(ue,{className:"w-4 h-4"})}),Le(t)&&e.jsx("button",{onClick:l=>$e(t.id,l),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:fe,children:e.jsx(We,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async l=>{l.stopPropagation(),await De(_.text)&&(q(t.id),setTimeout(()=>q(C=>C===t.id?null:C),1200))},title:ie===t.id?"Copied!":"Copy message",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:l=>{l.stopPropagation(),ne(N===t.id?null:t.id)},title:"Message info",children:e.jsx(Ve,{className:"w-4 h-4"})}),v===t.id&&e.jsx("div",{className:"absolute bottom-full left-0 mb-2 z-20",children:e.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:e.jsx("div",{className:"flex items-center gap-1",children:Se.map(({key:l,icon:f,title:C})=>e.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:C,onClick:()=>ce(t.id,l),children:e.jsx(se,{icon:f,className:"w-4 h-4"})},l))})})}),ie===t.id&&e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-gray-700 text-white text-xs px-2 py-0.5 rounded shadow",children:"Copied"}),N===t.id&&e.jsx("div",{className:"absolute bottom-full left-full ml-2 mb-2 z-20",children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[e.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),e.jsxs("div",{className:"text-gray-400",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"From:"})," ",t.sender_username]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"ID:"})," ",t.id]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(t.timestamp).toLocaleString()]}),c&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Channel:"})," ",c.name]})]})]})})]})]},t.id)})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-400",children:"No messages in this channel yet. Send the first one!"})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-400",children:"Please select a channel to start chatting."})}),e.jsx("div",{ref:ge})]}),e.jsx("div",{className:"bg-black px-2 pb-safe sticky bottom-0 left-0 right-0 md:relative md:bottom-auto",children:e.jsxs("div",{className:"p-4 border-t border-gray-700",children:[T&&e.jsxs("div",{className:"mb-2 flex items-center gap-2 rounded-md border border-gray-700 bg-gray-900 p-2",children:[e.jsx(ue,{className:"w-4 h-4 text-sca-purple"}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"text-xs text-gray-400",children:["Replying to ",T.sender_username]}),e.jsx("div",{className:"text-sm truncate",children:P(T.content).text})]}),e.jsx("button",{type:"button",className:"text-gray-400 hover:text-red-400 px-2",title:"Cancel reply",onClick:()=>W(null),children:"×"})]}),e.jsxs("form",{onSubmit:nt,className:"flex space-x-2",children:[e.jsx("input",{type:"file",accept:"image/*",ref:je,className:"hidden",onChange:ot}),e.jsx("button",{type:"button",onClick:lt,className:"bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3",children:e.jsx(wt,{className:"w-5 h-5"})}),e.jsx("input",{type:"text",ref:ae,value:R,onChange:t=>me(t.target.value),placeholder:c?`Message ${c.name}`:"Select a channel to type...",className:"flex-1 min-w-0 bg-gray-800 text-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sca-purple border border-gray-600",disabled:!c}),e.jsxs("button",{type:"submit",className:"bg-sca-purple hover:bg-sca-purple/80 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!c||!R.trim(),children:[e.jsx("span",{className:"hidden sm:inline",children:"Send"}),e.jsx("svg",{className:"w-5 h-5 sm:hidden",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})]})]})]})})]}),et&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gray-900 rounded-lg shadow-xl p-6 w-full max-w-md",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:G==="create"?"Create New Channel":"Edit Channel"}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),dt()},children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"channelName",className:"block text-sm font-medium mb-1",children:"Channel Name"}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"inline-flex items-center px-3 bg-gray-700 text-gray-400 border border-r-0 border-gray-600 rounded-l-md",children:"#"}),e.jsx("input",{type:"text",id:"channelName",value:D,onChange:t=>A(t.target.value),className:"flex-1 bg-gray-700 text-gray-100 border border-gray-600 rounded-r-md px-3 py-2 focus:outline-none",placeholder:"channel-name",required:!0})]})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",id:"isPrivate",checked:M,onChange:t=>F(t.target.checked),className:"sr-only"}),e.jsx("label",{htmlFor:"isPrivate",className:`w-4 h-4 border-2 rounded flex items-center justify-center cursor-pointer ${M?"bg-sca-purple border-sca-purple":"border-gray-300 bg-transparent"}`,children:M&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsx("label",{htmlFor:"isPrivate",className:"ml-2 cursor-pointer",children:"Private channel"})]})}),M&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Select members"}),e.jsxs("div",{className:"max-h-40 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md p-2",children:[ke.length===0&&e.jsx("p",{className:"text-gray-400 text-sm",children:"No users found."}),ke.map(t=>e.jsxs("div",{className:"flex items-center space-x-2 py-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",id:`channel-user-${t.id}`,checked:E.includes(t.id),onChange:()=>{I(s=>s.includes(t.id)?s.filter(a=>a!==t.id):[...s,t.id])},className:"sr-only"}),e.jsx("label",{htmlFor:`channel-user-${t.id}`,className:`w-4 h-4 border-2 rounded flex items-center justify-center cursor-pointer ${E.includes(t.id)?"bg-sca-purple border-sca-purple":"border-gray-300 bg-transparent"}`,children:E.includes(t.id)&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsx("label",{htmlFor:`channel-user-${t.id}`,className:"cursor-pointer",children:t.username})]},t.id))]})]}),U&&e.jsx("div",{className:"mb-4 bg-red-500/25 border border-red-500 text-red-100 p-2 rounded",children:U}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:()=>L(!1),className:"px-4 py-2 bg-transparent hover:text-sca-purple text-white font-medium rounded-md transition-colors disabled:opacity-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:!D.trim()||Ne,className:"px-4 py-2 bg-transparent hover:text-sca-purple text-white font-medium rounded-md transition-colors disabled:opacity-50",children:Ne?"Processing...":G==="create"?"Create":"Save"})]})]})]})}),we!=null&&(()=>{const{items:t}=it(we);return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:()=>re(null),children:e.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-4",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Thread"}),e.jsx("button",{className:"text-gray-400 hover:text-white",onClick:()=>re(null),title:"Close",children:"×"})]}),e.jsx("div",{className:"space-y-3",children:t.map(s=>{const a=!!n&&s.sender_id===n.id,i=P(s.content);return e.jsxs("div",{className:`p-3 rounded-xl border ${a?"bg-sca-purple/10 border-sca-purple/40":"bg-black/30 border-white/10"}`,children:[e.jsxs("div",{className:"text-xs text-gray-400 mb-1 flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-300",children:s.sender_username}),e.jsx("span",{children:_e(s.timestamp)})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words",children:i.text})]},`thread-${s.id}`)})})]})})})()]})};export{$t as default};
