import{b as ut,c as pt,r as p,j as t,f as b}from"./main-Du1GMxg9.js";import{g as P}from"./color-DkCkRny3.js";import{N as ie}from"./NebulaLoader-CImV6PIf.js";import{f as Oe,a as Ue,b as Ve,c as Be,N as He,I as qe,C as We,T as Qe,R as le,S as Ye,d as mt,P as xt}from"./index-ZAYiVvTg.js";import{f as Ke,a as Je,F as Y,b as ht}from"./index-BGVFnXmS.js";const wt=()=>{var Pe;const{user:n}=ut(),{unreadCounts:oe,markChannelAsRead:Xe,refreshNotifications:Ze,setActiveChannel:E}=pt(),[ce,F]=p.useState([]),[i,R]=p.useState(null),[j,w]=p.useState([]),[T,de]=p.useState(""),[ue,pe]=p.useState(!0),[et,me]=p.useState(!1),[xe,he]=p.useState(!1),[ge,k]=p.useState(null),fe=p.useRef(null),K=p.useRef(null),be=p.useRef(null),ye=p.useRef(null),[v,G]=p.useState(null),[N,J]=p.useState(null),[je,O]=p.useState(null),[L,U]=p.useState(null),[we,X]=p.useState(null),V=p.useRef(null),B=p.useRef(null),[tt,D]=p.useState(!1),[I,ve]=p.useState("create"),[Z,Ne]=p.useState(null),[Ce,ee]=p.useState(""),[H,q]=p.useState([]),[ke,te]=p.useState([]),[_e,Se]=p.useState(!1),[Me,_]=p.useState(""),$e=p.useMemo(()=>[{key:"heart",icon:Oe,title:"Heart"},{key:"thumbs_up",icon:Ue,title:"Like"},{key:"thumbs_down",icon:Ve,title:"Dislike"},{key:"laugh",icon:Be,title:"Laugh"},{key:"exclamation",icon:Ke,title:"Exclamation"},{key:"question",icon:Je,title:"Question"}],[]),st=p.useMemo(()=>({heart:Oe,thumbs_up:Ue,thumbs_down:Ve,laugh:Be,exclamation:Ke,question:Je}),[]),$=(e,s)=>{const[a,r]=[e,s].sort((l,o)=>l-o);return`dm_${a}_${r}`},se=e=>[...e].sort((s,a)=>new Date(s.timestamp)-new Date(a.timestamp)),Re=e=>{const s=new Date(e),a=new Date;return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()?s.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0}):s.toLocaleDateString(void 0,{month:"numeric",day:"numeric"})},ae=async(e=!1)=>{if(n)try{e||pe(!0),k(null);let s=[],a=[];try{const c=await b.get(`/chat/users/recent?user_id=${n.id}`);c.ok&&(s=await c.json())}catch{}try{const c=await b.get("/chat/users");c.ok&&(a=(await c.json()).filter(x=>x.id!==n.id))}catch{}const r=new Map;for(const c of s)r.set(c.id,c);for(const c of a)r.has(c.id)||r.set(c.id,c);const l=Array.from(r.values());let o=[];const m=await b.get(`/chat/groups?user_id=${n.id}`);m.ok&&(o=await m.json());const u=[...o.map(c=>({...c,type:"group"})),...l.map(c=>({...c,type:"dm"}))];u.sort((c,x)=>{const S=c.type==="group"?c.last_activity||c.created_at||"":c.last_message_time||"",h=x.type==="group"?x.last_activity||x.created_at||"":x.last_message_time||"";if(S&&h)return h.localeCompare(S);if(S)return-1;if(h)return 1;const g=c.type==="group"?c.name:c.username,y=x.type==="group"?x.name:x.username;return g.localeCompare(y,void 0,{sensitivity:"base"})}),F(u),e||!(i&&u.some(x=>x.type===i.type&&x.id===i.id))&&u.length>0&&ne(u[0])}catch{k("Error loading chats")}finally{e||pe(!1)}};p.useEffect(()=>{n&&ae()},[n]),p.useEffect(()=>{(async()=>{if(!(!i||!n)){me(!0),k(null);try{let s="";i.type==="dm"?s=`/chat/messages/dm/${$(n.id,i.id)}?user_id=${n.id}`:s=`/chat/messages/${i.id}?user_id=${n.id}`;const a=await b.get(s);a.ok?w(se(await a.json())):w([])}catch{w([])}finally{me(!1)}}})()},[i,n]),p.useEffect(()=>{var e;(e=fe.current)==null||e.scrollIntoView({behavior:"smooth"})},[j]),p.useEffect(()=>()=>E(null),[E]),p.useEffect(()=>{if(i&&n){const e=i.type==="dm"?$(n.id,i.id):i.id.toString();E(e)}},[i,n,E]),p.useEffect(()=>{const e=s=>{const a=s.target,r=V.current&&a?V.current.contains(a):!1,l=B.current&&a?B.current.contains(a):!1;r||G(null),l||J(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[v,N]);const De=async()=>{try{const e=await b.get("/chat/users");e.ok?te(await e.json()):te([])}catch{te([])}},Ie=async()=>{ve("create"),Ne(null),ee(""),q([]),_(""),await De(),D(!0)},Ee=async e=>{ve("edit"),Ne(e.id),ee(e.name||""),q([]),_(""),await De();try{const s=await b.get(`/chat/channels/${e.id}/members`);if(s.ok){const r=(await s.json()||[]).map(l=>l.user_id).filter(l=>l!==(n==null?void 0:n.id));q(r)}}catch{}D(!0)},at=e=>{q(s=>s.includes(e)?s.filter(a=>a!==e):[...s,e])},nt=async()=>{if(!n)return;_("");const e=Ce.trim();if(!e){_("Group name is required");return}if(H.length===0&&I==="create"){_("Select at least one member");return}Se(!0);try{if(I==="create"){const s=await b.post("/chat/groups",{name:e,created_by:n.id,members:H});if(s.ok){const a=await s.json();D(!1),await ae(!0);const r={type:"group",id:a.id,name:a.name};R(r)}else{const a=await s.text();_(a||"Failed to create group")}}else{const s=Array.from(new Set([...H||[],n.id])),a=await b.put(`/chat/groups/${Z}`,{name:e,members:s});if(a.ok)D(!1),await ae(!0),F(r=>r.map(l=>l.type==="group"&&l.id===Z?{...l,name:e}:l)),R(r=>r&&r.type==="group"&&r.id===Z?{...r,name:e}:r);else{const r=await a.text();_(r||"Failed to update group")}}}catch{_(I==="create"?"Error creating group":"Error updating group")}finally{Se(!1)}},Te=async e=>{if(!(!n||e.type!=="group")&&window.confirm(`Delete group "${e.name}"? All messages will be permanently deleted.`))try{(await b.delete(`/chat/groups/${e.id}`)).ok&&(F(a=>a.filter(r=>!(r.type==="group"&&r.id===e.id))),i&&i.type==="group"&&i.id===e.id&&R(null))}catch{}},ne=e=>{if(R(e),!n)return;const s=e.type==="dm"?$(n.id,e.id):e.id.toString();E(s),Xe(s)},z=e=>{const s=e.match(/^::reply\[(\d+)\]::([\s\S]*)$/);return s?{replyId:parseInt(s[1],10),text:s[2]}:{replyId:null,text:e}},rt=async e=>{if(e.preventDefault(),!(!T.trim()||!i||!n))try{const s=L?`::reply[${L.id}]::${T.trim()}`:T.trim();let a="";if(i.type==="dm"?a=`/chat/messages/dm/${$(n.id,i.id)}?user_id=${n.id}`:a=`/chat/messages/${i.id}?user_id=${n.id}`,(await b.post(a,{content:s,sender_id:n.id})).ok){const l=await b.get(a);l.ok&&w(se(await l.json())),de(""),U(null),Ze(),F(o=>{const m=o.findIndex(u=>u.type===i.type&&u.id===i.id);if(m>=0){const u=[...o],[c]=u.splice(m,1),x=new Date().toISOString();return c.type==="dm"?c.last_message_time=x:c.last_activity=x,u.unshift(c),u}return o})}}catch{k("Error sending message")}},Le=async(e,s)=>{if(n&&!(!(s!=null&&s.shiftKey)&&!window.confirm("Delete this message?"))){he(!0);try{(await b.request("DELETE",`/chat/messages/${e}`,{user_id:n.id})).ok&&w(r=>r.filter(l=>l.id!==e))}catch{}finally{he(!1)}}},ze=async e=>{try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0}catch{}try{const s=document.createElement("textarea");s.value=e,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.focus(),s.select();const a=document.execCommand("copy");return document.body.removeChild(s),a}catch{return!1}},it=e=>new Promise((s,a)=>{const r=new FileReader;r.onload=()=>{const l=r.result;if(typeof l=="string"){const o=l.indexOf(",");s({base64:l.substring(o+1),contentType:e.type||"application/octet-stream"})}else a(new Error("Unsupported result type"))},r.onerror=a,r.readAsDataURL(e)}),lt=()=>{var e;return(e=be.current)==null?void 0:e.click()},ot=async e=>{var a;const s=(a=e.target.files)==null?void 0:a[0];if(!(!s||!n||!i))try{const{base64:r,contentType:l}=await it(s),o=await b.post("/uploads/image",{dataBase64:r,contentType:l,filename:s.name||"image"});if(o.ok){const{url:m}=await o.json(),u=i.type==="dm"?`/chat/messages/dm/${$(n.id,i.id)}?user_id=${n.id}`:`/chat/messages/${i.id}?user_id=${n.id}`;await b.post(u,{content:`::image::${m}`,sender_id:n.id});const c=await b.get(u);c.ok&&w(se(await c.json()))}}catch{k("Failed to attach image")}finally{e.target.value=""}},re=async(e,s)=>{if(!(!s||!n)){w(a=>a.map(r=>{if(r.id!==e)return r;const l={...r.reaction_counts||{}},o=new Set(r.my_reactions||[]);if(o.has(s)){const u=(l[s]||0)-1;u<=0?delete l[s]:l[s]=u,o.delete(s)}else l[s]=(l[s]||0)+1,o.add(s);return{...r,reaction_counts:l,my_reactions:Array.from(o)}})),G(null);try{(await b.post(`/chat/messages/${e}/reactions/${s}/toggle?user_id=${n.id}`)).ok||(w(r=>r.map(l=>{if(l.id!==e)return l;const o={...l.reaction_counts||{}},m=new Set(l.my_reactions||[]);if(m.has(s)){const c=(o[s]||0)-1;c<=0?delete o[s]:o[s]=c,m.delete(s)}else o[s]=(o[s]||0)+1,m.add(s);return{...l,reaction_counts:o,my_reactions:Array.from(m)}})),k("Failed to toggle reaction"))}catch{w(a=>a.map(r=>{if(r.id!==e)return r;const l={...r.reaction_counts||{}},o=new Set(r.my_reactions||[]);if(o.has(s)){const u=(l[s]||0)-1;u<=0?delete l[s]:l[s]=u,o.delete(s)}else l[s]=(l[s]||0)+1,o.add(s);return{...r,reaction_counts:l,my_reactions:Array.from(o)}})),k("Failed to toggle reaction")}}},ct=e=>{const s=new Map(j.map(h=>[h.id,h])),a=new Map,r=new Map;for(const h of j){const{replyId:g}=z(h.content);if(g){a.set(h.id,g);const y=r.get(g)||[];y.push(h.id),r.set(g,y)}}const l=[],o=new Set;let m=e;for(;m!==void 0&&!o.has(m);){o.add(m);const h=a.get(m);if(h!=null){const g=s.get(h);g&&l.unshift(g),m=h}else break}const u=[],c=[e],x=new Set([e]);for(;c.length;){const h=c.shift(),g=r.get(h)||[];for(const y of g){if(x.has(y))continue;x.add(y);const W=s.get(y);W&&u.push(W),c.push(y)}}u.sort((h,g)=>new Date(h.timestamp)-new Date(g.timestamp));const S=s.get(e);return{items:[...l,...S?[S]:[],...u]}},Ae=e=>!!n&&(n.isAdmin||e.sender_id===n.id);return t.jsxs("div",{className:"flex h-full w-full min-w-0 bg-black text-gray-100 overflow-hidden",children:[t.jsxs("div",{className:"hidden md:flex w-64 bg-black flex-col",children:[t.jsx("div",{className:"px-2",children:t.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex justify-between items-center",children:[t.jsx("h2",{className:"text-xl font-bold",children:"Messages"}),t.jsx("button",{onClick:Ie,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-1",title:"Create group chat",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})}),ue?t.jsx("div",{className:"flex items-center justify-center p-4",children:t.jsx(ie,{size:48})}):t.jsx("nav",{className:"flex-1 p-2 space-y-2 overflow-y-auto",children:ce.map(e=>{const s=`${e.type}-${e.id}`,a=e.type==="group"?e.name:e.username,r=e.type==="group"?"#4b5563":e.avatar_color||P(a,null),l=e.type==="dm"&&n?$(n.id,e.id):e.id.toString(),o=oe[l]||0,m=(i==null?void 0:i.type)===e.type&&(i==null?void 0:i.id)===e.id;return t.jsxs("div",{className:`flex items-center justify-between w-full py-2 px-3 rounded-md ${m?"bg-sca-purple text-white":"hover:text-sca-purple"}`,children:[t.jsxs("button",{onClick:()=>ne(e),className:"flex items-center gap-3 flex-1 text-left",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm",style:{backgroundColor:r},children:a==null?void 0:a.split(" ").map(u=>u[0]).join("").toUpperCase().substring(0,2)}),o>0&&t.jsx(He,{count:o,position:"top-right",size:"medium"})]}),t.jsx("span",{className:"truncate",children:a})]}),(n==null?void 0:n.isAdmin)&&e.type==="group"&&t.jsxs("div",{className:"flex gap-2 pl-2",children:[t.jsx("button",{onClick:u=>{u.stopPropagation(),Ee(e)},className:"text-gray-400 hover:text-white",title:"Edit group",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})})}),t.jsx("button",{onClick:u=>{u.stopPropagation(),Te(e)},className:"text-gray-400 hover:text-red-400",title:"Delete group",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]},s)})})]}),t.jsx("div",{className:`md:hidden ${i?"hidden":"flex-1 min-h-0"}`,onClick:e=>{if(i||e.target.closest('button, a, input, textarea, select, label, [role="button"]'))return;const s=ye.current;s&&R(s)},children:i?null:t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{className:"text-xl font-bold",children:"Messages"}),t.jsx("button",{onClick:Ie,className:"bg-black hover:bg-sca-purple text-sca-purple hover:text-white rounded-full p-2",title:"Create group chat",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),ue?t.jsx("div",{className:"flex items-center justify-center p-8",children:t.jsx(ie,{size:48})}):t.jsx("div",{className:"space-y-3",children:ce.map(e=>{const s=`${e.type}-${e.id}`,a=e.type==="group"?e.name:e.username,r=e.type==="group"?"#4b5563":e.avatar_color||P(a,null),l=e.type==="dm"&&n?$(n.id,e.id):e.id.toString(),o=oe[l]||0;return t.jsxs("div",{className:"w-full py-4 px-4 rounded-xl border border-gray-700 hover:border-sca-purple hover:bg-gray-800 active:bg-gray-700 transition-all duration-200 flex items-center justify-between mobile-touch-target",children:[t.jsxs("button",{onClick:()=>ne(e),className:"flex items-center gap-3 flex-1 text-left",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-base",style:{backgroundColor:r},children:a==null?void 0:a.split(" ").map(m=>m[0]).join("").toUpperCase().substring(0,2)}),o>0&&t.jsx(He,{count:o,position:"top-right",size:"medium"})]}),t.jsx("span",{className:"font-medium text-base",children:a})]}),(n==null?void 0:n.isAdmin)&&e.type==="group"&&t.jsxs("div",{className:"flex gap-3 pl-2",children:[t.jsx("button",{onClick:m=>{m.stopPropagation(),Ee(e)},className:"text-gray-400 hover:text-white",title:"Edit group",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{d:"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"})})}),t.jsx("button",{onClick:m=>{m.stopPropagation(),Te(e)},className:"text-gray-400 hover:text-red-400",title:"Delete group",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})]},s)})})]})}),t.jsxs("div",{className:`flex-1 flex flex-col min-h-0 min-w-0 ${i?"":"hidden md:flex"}`,children:[t.jsx("div",{className:"bg-black px-2 w-full",children:t.jsxs("div",{className:"px-4 pb-4 border-b border-gray-700 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("button",{onClick:()=>{ye.current=i,R(null)},className:"md:hidden mr-3 p-2 hover:text-sca-purple hover:bg-gray-800 rounded-lg transition-colors mobile-touch-target",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),t.jsx("h2",{className:"text-lg md:text-xl font-bold truncate",children:i?i.type==="group"?i.name:i.username:"Select a chat"})]}),t.jsxs("div",{className:"hidden md:flex items-center",children:[t.jsx("div",{className:"w-10 h-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-lg",style:{backgroundColor:n!=null&&n.name?P(n.name,(n==null?void 0:n.avatarColor)||null):"#471a67"},children:(Pe=n==null?void 0:n.name)==null?void 0:Pe.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2)}),t.jsxs("div",{children:[t.jsx("p",{className:"font-semibold",children:n==null?void 0:n.name}),t.jsx("p",{className:"text-sm text-gray-400",children:"Online"})]})]})]})}),ge&&t.jsxs("div",{className:"bg-red-500 text-white p-2 text-sm text-center",children:[ge,t.jsx("button",{onClick:()=>k(null),className:"ml-2 font-bold",children:"×"})]}),t.jsxs("div",{className:"flex-1 min-w-0 p-4 overflow-y-auto overflow-x-hidden pb-20 md:pb-4",children:[et?t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsx(ie,{size:64})}):i?j.length>0?t.jsx("div",{className:"flex flex-col justify-end min-h-full",children:j.map((e,s)=>{var Ge;const a=!!n&&e.sender_id===n.id,r=s>0?j[s-1]:null,l=s<j.length-1?j[s+1]:null,o=(i==null?void 0:i.type)==="group",m=12e4,u=new Date(e.timestamp).getTime(),c=r?new Date(r.timestamp).getTime():0,x=l?new Date(l.timestamp).getTime():0,S=!!r&&r.sender_id===e.sender_id,h=!!l&&l.sender_id===e.sender_id,g=!(S&&u-c<=m),y=!(h&&x-u<=m),W=t.jsx("div",{className:"w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white font-bold text-sm md:text-lg",style:{backgroundColor:e.sender_avatar_color||P(e.sender_username,null)},children:(Ge=e.sender_username)==null?void 0:Ge.split(" ").map(d=>d[0]).join("").toUpperCase().substring(0,2)}),dt=(()=>{const d=!a&&g&&o?"rounded-2xl":"rounded-3xl",f=[];return g||f.push(a?"rounded-tr-md":"rounded-tl-md"),y||f.push(a?"rounded-br-md":"rounded-bl-md"),[d,...f].join(" ")})(),M=z(e.content),Q=M.replyId?j.find(d=>d.id===M.replyId):null,Fe=Q?z(Q.content):null,A=Fe?Fe.text:"";return t.jsxs("div",{id:`msg-${e.id}`,className:`relative flex items-end gap-2 mb-1 ${g?"mt-3":"mt-0"} group ${a?"justify-end":"justify-start"}`,children:[!a&&o&&(y?t.jsx("div",{className:"self-end",children:W}):t.jsx("div",{className:"w-8 md:w-10"})),a&&t.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${v===e.id||N===e.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:d=>{v===e.id&&(V.current=d),N===e.id&&(B.current=d)},children:[t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),J(N===e.id?null:e.id)},title:"Message info",children:t.jsx(qe,{className:"w-4 h-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async d=>{d.stopPropagation(),await ze(M.text)&&(O(e.id),setTimeout(()=>O(C=>C===e.id?null:C),1200))},title:je===e.id?"Copied!":"Copy message",children:t.jsx(We,{className:"w-4 h-4"})}),Ae(e)&&t.jsx("button",{onClick:d=>Le(e.id,d),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:xe,children:t.jsx(Qe,{className:"h-4 w-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),U(e),setTimeout(()=>{var f;return(f=K.current)==null?void 0:f.focus()},0)},title:"Reply",children:t.jsx(le,{className:"w-4 h-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),G(v===e.id?null:e.id)},title:"Add reaction",children:t.jsx(Ye,{className:"w-4 h-4"})}),v===e.id&&t.jsx("div",{className:"absolute bottom-full right-0 mb-2 z-20",children:t.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:t.jsx("div",{className:"flex items-center gap-1",children:$e.map(({key:d,icon:f,title:C})=>t.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:C,onClick:()=>re(e.id,d),children:t.jsx(Y,{icon:f,className:"w-4 h-4"})},d))})})}),N===e.id&&t.jsx("div",{className:"absolute bottom-full right-full mr-2 mb-2 z-20",children:t.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[t.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),t.jsxs("div",{className:"text-gray-400",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"From:"})," ",e.sender_username]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"ID:"})," ",e.id]}),t.jsxs("div",{className:"mt-1",children:[t.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(e.timestamp).toLocaleString()]}),i&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"Chat:"})," ",i.type==="group"?i.name:i.username]})]})]})})]}),t.jsxs("div",{className:`max-w-[85%] px-3 py-2 ${dt} shadow-sm ${a?"bg-sca-purple text-white":"bg-gray-800 text-gray-100"}`,children:[M.replyId&&t.jsx("button",{type:"button",onClick:()=>X(e.id),className:`mb-1 text-xs rounded-md px-2 py-1 border ${a?"bg-white/10 border-white/30 text-white/90":"bg-black/20 border-white/10 text-gray-300"}`,title:"View replied message",children:t.jsxs("span",{className:"opacity-80",children:["Replying to ",Q?Q.sender_username:"message",": ",A==null?void 0:A.slice(0,80),A&&A.length>80?"…":""]})}),!a&&g&&o&&t.jsx("div",{className:"text-xs font-semibold mb-1 opacity-90",children:e.sender_username}),t.jsxs("div",{className:`whitespace-pre-wrap break-words ${a?"text-right":""}`,children:[M.text.startsWith("::image::")?t.jsx("img",{src:M.text.replace("::image::",""),alt:"attachment",className:"max-w-full rounded-lg border border-white/10"}):t.jsx("span",{children:M.text}),y&&t.jsxs("span",{className:`ml-2 text-[10px] ${a?"text-white/80":"text-gray-400"} whitespace-nowrap align-baseline`,children:[Re(e.timestamp),a&&t.jsx("span",{className:"ml-1 inline-flex items-center align-baseline",children:t.jsx(Y,{icon:e.read_by_any?ht:mt,className:"w-3.5 h-3.5 opacity-90",title:e.read_by_any?"Read":"Sent"})})]}),Object.keys(e.reaction_counts||{}).length>0&&t.jsx("div",{className:`mt-1 flex flex-wrap gap-1 ${a?"justify-end":"justify-start"}`,children:Object.entries(e.reaction_counts||{}).map(([d,f])=>t.jsxs("button",{type:"button",onClick:()=>re(e.id,d),className:`px-1.5 py-0.5 rounded-full text-xs border transition-colors ${(e.my_reactions||[]).includes(d)?a?"bg-white/20 border-white/40":"bg-white/10 border-white/20":a?"bg-black/10 border-white/20":"bg-black/20 border-white/10"}`,title:"Toggle reaction",children:[t.jsx(Y,{icon:st[d],className:"w-3.5 h-3.5 mr-1 inline-block"}),t.jsx("span",{className:"tabular-nums",children:f})]},d))})]})]}),!a&&t.jsxs("div",{className:`relative flex items-center gap-1 transition-opacity text-gray-400 ${v===e.id||N===e.id?"opacity-100":"opacity-0 group-hover:opacity-100"}`,ref:d=>{v===e.id&&(V.current=d),N===e.id&&(B.current=d)},children:[t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),G(v===e.id?null:e.id)},title:"Add reaction",children:t.jsx(Ye,{className:"w-4 h-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),U(e),setTimeout(()=>{var f;return(f=K.current)==null?void 0:f.focus()},0)},title:"Reply",children:t.jsx(le,{className:"w-4 h-4"})}),Ae(e)&&t.jsx("button",{onClick:d=>Le(e.id,d),className:"hover:text-red-400 text-current",title:`Delete message
(Hold Shift to skip confirmation)`,disabled:xe,children:t.jsx(Qe,{className:"h-4 w-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:async d=>{d.stopPropagation(),await ze(M.text)&&(O(e.id),setTimeout(()=>O(C=>C===e.id?null:C),1200))},title:je===e.id?"Copied!":"Copy message",children:t.jsx(We,{className:"w-4 h-4"})}),t.jsx("button",{type:"button",className:"hover:text-sca-purple",onClick:d=>{d.stopPropagation(),J(N===e.id?null:e.id)},title:"Message info",children:t.jsx(qe,{className:"w-4 h-4"})}),v===e.id&&t.jsx("div",{className:"absolute bottom-full left-0 mb-2 z-20",children:t.jsx("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-2 shadow-xl whitespace-nowrap",children:t.jsx("div",{className:"flex items-center gap-1",children:$e.map(({key:d,icon:f,title:C})=>t.jsx("button",{type:"button",className:"px-1.5 py-1 rounded hover:bg-gray-800",title:C,onClick:()=>re(e.id,d),children:t.jsx(Y,{icon:f,className:"w-4 h-4"})},d))})})}),N===e.id&&t.jsx("div",{className:"absolute bottom-full left-full ml-2 mb-2 z-20",children:t.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3 shadow-xl text-sm min-w-[260px] max-w-xs",children:[t.jsx("div",{className:"text-gray-300 font-medium mb-1",children:"Message info"}),t.jsxs("div",{className:"text-gray-400",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"From:"})," ",e.sender_username]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"ID:"})," ",e.id]}),t.jsxs("div",{className:"mt-1",children:[t.jsx("span",{className:"text-gray-500",children:"Sent:"})," ",new Date(e.timestamp).toLocaleString()]}),i&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"Chat:"})," ",i.type==="group"?i.name:i.username]})]})]})})]})]},e.id)})}):t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsx("p",{className:"text-gray-400",children:"No messages yet. Say hi!"})}):t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsx("p",{className:"text-gray-400",children:"Select a chat to start messaging."})}),t.jsx("div",{ref:fe})]}),t.jsx("div",{className:"bg-black px-2 pb-safe sticky bottom-0 left-0 right-0 md:relative md:bottom-auto",children:t.jsxs("div",{className:"p-4 border-t border-gray-700",children:[L&&t.jsxs("div",{className:"mb-2 flex items-center gap-2 rounded-md border border-gray-700 bg-gray-900 p-2",children:[t.jsx(le,{className:"w-4 h-4 text-sca-purple"}),t.jsxs("div",{className:"flex-1 overflow-hidden",children:[t.jsxs("div",{className:"text-xs text-gray-400",children:["Replying to ",L.sender_username]}),t.jsx("div",{className:"text-sm truncate",children:z(L.content).text})]}),t.jsx("button",{type:"button",className:"text-gray-400 hover:text-red-400 px-2",title:"Cancel reply",onClick:()=>U(null),children:"×"})]}),t.jsxs("form",{onSubmit:rt,className:"flex space-x-2",children:[t.jsx("input",{type:"file",accept:"image/*",ref:be,className:"hidden",onChange:ot}),t.jsx("button",{type:"button",onClick:lt,className:"bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3",children:t.jsx(xt,{className:"w-5 h-5"})}),t.jsx("input",{type:"text",ref:K,value:T,onChange:e=>de(e.target.value),placeholder:i?`Message ${i.type==="group"?i.name:i.username}`:"Select a chat...",className:"flex-1 min-w-0 bg-gray-800 text-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sca-purple border border-gray-600",disabled:!i}),t.jsxs("button",{type:"submit",className:"bg-sca-purple hover:bg-sca-purple/80 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!i||!T.trim(),children:[t.jsx("span",{className:"hidden sm:inline",children:"Send"}),t.jsx("svg",{className:"w-5 h-5 sm:hidden",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})]})]})]})})]}),we!=null&&(()=>{const{items:e}=ct(we);return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:()=>X(null),children:t.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-4",onClick:s=>s.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h3",{className:"text-lg font-semibold",children:"Thread"}),t.jsx("button",{className:"text-gray-400 hover:text-white",onClick:()=>X(null),title:"Close",children:"×"})]}),t.jsx("div",{className:"space-y-3",children:e.map(s=>{const a=!!n&&s.sender_id===n.id,r=z(s.content);return t.jsxs("div",{className:`p-3 rounded-xl border ${a?"bg-sca-purple/10 border-sca-purple/40":"bg-black/30 border-white/10"}`,children:[t.jsxs("div",{className:"text-xs text-gray-400 mb-1 flex items-center justify-between",children:[t.jsx("span",{className:"font-medium text-gray-300",children:s.sender_username}),t.jsx("span",{children:Re(s.timestamp)})]}),t.jsx("div",{className:"whitespace-pre-wrap break-words",children:r.text})]},`thread-${s.id}`)})})]})})})(),tt&&t.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:()=>D(!1),children:t.jsxs("div",{className:"bg-gray-900 border border-white/10 rounded-lg p-5 w-full max-w-md",onClick:e=>e.stopPropagation(),children:[t.jsx("h3",{className:"text-lg font-semibold mb-3",children:I==="create"?"New Group Chat":"Edit Group Chat"}),Me&&t.jsx("div",{className:"mb-2 bg-red-500/20 text-red-200 border border-red-500/40 rounded p-2",children:Me}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-gray-400",children:"Group name"}),t.jsx("input",{value:Ce,onChange:e=>ee(e.target.value),placeholder:"Project Tigers",className:"w-full px-3 py-2 rounded bg-gray-800 border border-white/10"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Select members"}),t.jsxs("div",{className:"max-h-48 overflow-y-auto bg-gray-800 border border-white/10 rounded p-2",children:[ke.length===0&&t.jsx("p",{className:"text-gray-400 text-sm",children:"No users found."}),ke.map(e=>{var s;return t.jsxs("label",{className:"flex items-center gap-2 py-1 text-sm",children:[t.jsx("input",{type:"checkbox",disabled:e.id===(n==null?void 0:n.id),checked:e.id===(n==null?void 0:n.id)?!0:H.includes(e.id),onChange:()=>at(e.id)}),t.jsxs("span",{className:"inline-flex items-center gap-2",children:[t.jsx("span",{className:"w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:e.avatar_color||P(e.username,null)},children:(s=e.username)==null?void 0:s.split(" ").map(a=>a[0]).join("").toUpperCase().substring(0,2)}),e.username,e.id===(n==null?void 0:n.id)&&t.jsx("span",{className:"text-xs text-gray-400",children:"(you)"})]})]},e.id)})]})]})]}),t.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[t.jsx("button",{onClick:()=>D(!1),className:"px-4 py-2 rounded bg-white/10",children:"Cancel"}),t.jsx("button",{onClick:nt,disabled:_e,className:"px-4 py-2 rounded bg-sca-purple disabled:opacity-50",children:_e?I==="create"?"Creating…":"Saving…":I==="create"?"Create Group":"Save Changes"})]})]})})]})};export{wt as default};
